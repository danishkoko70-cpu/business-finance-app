<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reports â€¢ Finance App</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><img src="/assets/img/logo.png" alt=""/></div>
        <div>
          <h1 id="brandTitle">My Business Finance</h1>
          <small></small>
        </div>
      </div>
      <div class="userchip" id="topbarUser"></div>
    </div>

    <div class="grid">
      <aside class="sidebar">
        <nav class="nav">
          <a href="dashboard.html">Dashboard <span class="badge" data-count="income">0</span></a>
          <a href="income.html">Income <span class="badge" data-count="income">0</span></a>
          <a href="expense.html">Expense <span class="badge" data-count="expense">0</span></a>
          <a href="sales.html">Sales <span class="badge" data-count="sales">0</span></a>
          <a href="clients.html">Clients <span class="badge" data-count="clients">0</span></a>
          <a href="purchases.html">Purchases <span class="badge" data-count="purchases">0</span></a>
          <a href="bank.html">Bank <span class="badge" data-count="bank">0</span></a>
          <a href="approvals.html">Approvals <span class="badge" id="pendingBadge" data-count="approvals">0</span></a>
          <a href="reports.html">Reports <span class="badge">CSV</span></a>
          <a href="settings.html">Settings <span class="badge">Admin</span></a>
          <a href="profile.html">Profile <span class="badge">Me</span></a>
          <a href="help.html">Help <span class="badge">Guide</span></a>
        </nav>
        <hr/>
        <div class="small">
          <b>Login default:</b><br/>
          admin / admin123<br/>
          manager / manager123<br/>
          <div style="margin-top:10px">
            <button class="btn btn-small" id="btnBackup">Backup</button>
            <button class="btn btn-small" id="btnReset">Reset</button>
          </div>
          <div style="margin-top:8px" class="small">
            Backup downloads JSON (safe). Reset clears local data for this browser.
          </div>
        </div>
      </aside>

      <main class="main">
        
<div class="vstack">
  <div class="hstack" style="justify-content:space-between;">
    <div>
      <h2 style="margin:0">Reports</h2>
      <div class="small">Download CSV for any module, and see Profit/Loss summary.</div>
    </div>
    <div class="hstack">
      <button class="btn btn-small" id="btnBackup2">Backup JSON</button>
    </div>
  </div>

  <div class="card">
    <b>Export CSV</b>
    <div class="hstack" style="margin-top:10px; flex-wrap:wrap">
      <button class="btn" data-exp="income">Income</button>
      <button class="btn" data-exp="expense">Expense</button>
      <button class="btn" data-exp="sales">Sales</button>
      <button class="btn" data-exp="purchases">Purchases</button>
      <button class="btn" data-exp="bank">Bank</button>
      <button class="btn" data-exp="approvals">Approvals</button>
    </div>
    <div class="small" style="margin-top:10px">
      CSV opens in Excel. If you want full backup, use Backup JSON.
    </div>
  </div>

  <div class="card">
    <b>Profit & Loss</b>
    <div class="kpis" style="margin-top:10px">
      <div class="card kpi">
        <div class="label">Income + Sales</div>
        <div class="value" id="rIncome">0</div>
        <div class="sub small">Approved only</div>
      </div>
      <div class="card kpi">
        <div class="label">Expense + Purchases</div>
        <div class="value" id="rExpense">0</div>
        <div class="sub small">Approved only</div>
      </div>
      <div class="card kpi">
        <div class="label">Net Profit/Loss</div>
        <div class="value" id="rPL">0</div>
        <div class="sub small" id="rPLSub"></div>
      </div>
      <div class="card kpi">
        <div class="label">Bank Balance</div>
        <div class="value" id="rBank">0</div>
        <div class="sub small">Deposits - Withdrawals</div>
      </div>
    </div>
  </div>

  <div class="card">
    <b>Quick Notes</b>
    <div class="formgrid" style="grid-template-columns: 1fr 140px; margin-top:10px">
      <div>
        <label>Note</label>
        <input class="input" id="noteText" placeholder="Write a note (saved locally)"/>
      </div>
      <div style="display:flex; align-items:flex-end">
        <button class="btn btn-primary" id="btnAddNote">Add</button>
      </div>
    </div>
    <div id="notes" style="margin-top:10px" class="vstack"></div>
  </div>
</div>

      </main>
    </div>
  </div>

  <script src="assets/js/app.js"></script>
  <script src="assets/js/ui.js"></script>
  
<script>
(function(){
  const auth = BMApp.requireAuth();
  if(!auth) return;
  const {st} = auth;
  const currency = st.company.currency || "";

  function sumIncome(){
    const income = (st.data.income||[]).filter(r=>r.status==="approved").reduce((a,b)=>a+Number(b.amount||0),0);
    const sales = (st.data.sales||[]).filter(r=>r.status==="approved").reduce((a,b)=>a+Number(b.total||0),0);
    return income + sales;
  }
  function sumExpense(){
    const expense = (st.data.expense||[]).filter(r=>r.status==="approved").reduce((a,b)=>a+Number(b.amount||0),0);
    const purchases = (st.data.purchases||[]).filter(r=>r.status==="approved").reduce((a,b)=>a+Number(b.total||0),0);
    return expense + purchases;
  }
  function bankBalance(){
    return (st.data.bank||[]).filter(r=>r.status==="approved").reduce((a,b)=>{
      const amt = Number(b.amount||0);
      return a + (b.txnType==="withdraw" ? -amt : amt);
    },0);
  }

  const inc = sumIncome();
  const exp = sumExpense();
  const pl = inc - exp;

  BMApp.qs("#rIncome").textContent = BMApp.fmtMoney(inc, currency);
  BMApp.qs("#rExpense").textContent = BMApp.fmtMoney(exp, currency);
  BMApp.qs("#rPL").textContent = BMApp.fmtMoney(pl, currency);
  BMApp.qs("#rPLSub").textContent = pl>=0 ? "Profit" : "Loss";
  BMApp.qs("#rBank").textContent = BMApp.fmtMoney(bankBalance(), currency);

  BMApp.qsa("[data-exp]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const type = btn.getAttribute("data-exp");
      const res = BMApp.exportCSV(type);
      if(!res.ok) BMApp.toast(res.message||"Nothing to export", "warn");
    });
  });

  BMApp.qs("#btnBackup2").addEventListener("click", ()=>BMApp.downloadBackup());

  // Notes
  function renderNotes(){
    const notes = (st.data.notes||[]);
    const box = BMApp.qs("#notes");
    box.innerHTML = "";
    notes.slice(0,10).forEach(n=>{
      const row = document.createElement("div");
      row.className="hstack";
      row.style.justifyContent="space-between";
      row.innerHTML = `<span>${BMUI.escapeHtml(n.text||"")}</span>
        <span class="small">${new Date(n.createdAt).toLocaleString()}</span>`;
      box.appendChild(row);
    });
    if(!notes.length) box.innerHTML = `<div class="small">No notes yet.</div>`;
  }

  BMApp.qs("#btnAddNote").addEventListener("click", ()=>{
    const t = BMApp.qs("#noteText").value.trim();
    if(!t) return BMApp.toast("Write a note first.", "warn");
    const st2 = BMApp.loadState();
    st2.data.notes = st2.data.notes || [];
    st2.data.notes.unshift({id:"note_"+Date.now(), text:t, createdAt:new Date().toISOString()});
    BMApp.saveState(st2);
    location.reload();
  });

  renderNotes();
})();
</script>

  <script>
    // global sidebar actions
    (function(){
      const auth = BMApp.requireAuth();
      if(!auth) return;
      BMUI.renderTopbar();
      BMUI.setActiveNav();
      BMUI.setCounts();

      const backupBtn = BMApp.qs("#btnBackup");
      if(backupBtn) backupBtn.addEventListener("click", ()=>BMApp.downloadBackup());

      const resetBtn = BMApp.qs("#btnReset");
      if(resetBtn) resetBtn.addEventListener("click", ()=>{
        if(confirm("Reset all data on this browser?")){
          BMApp.resetAll();
          BMApp.toast("Reset done. Please login again.", "warn");
          setTimeout(()=>location.href="login.html", 500);
        }
      });
    })();
  </script>
</body>
</html>
